<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATLAS Premium Platform</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        @keyframes slide-up {
            0% {
                opacity: 0;
                transform: translateY(40px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slide-in-right {
            0% {
                opacity: 0;
                transform: translateX(100px);
            }

            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slide-in-left {
            0% {
                opacity: 0;
                transform: translateX(-100px);
            }

            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes message-pop {
            0% {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }

            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes view-transition {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fade-in {
            0% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
            }

            50% {
                box-shadow: 0 0 40px rgba(59, 130, 246, 0.6);
            }
        }

        .animate-float {
            animation: float 6s ease-in-out infinite;
        }

        .animate-slide-up {
            animation: slide-up 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .animate-slide-up-delay-1 {
            animation: slide-up 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.15s forwards;
            opacity: 0;
        }

        .animate-slide-up-delay-2 {
            animation: slide-up 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.3s forwards;
            opacity: 0;
        }

        .animate-slide-in-right {
            animation: slide-in-right 0.4s ease-out forwards;
        }

        .animate-slide-in-left {
            animation: slide-in-left 0.4s ease-out forwards;
        }

        .animate-message {
            animation: message-pop 0.3s ease-out;
        }

        .animate-view-transition {
            animation: view-transition 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }

        .animate-pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }


        .glass-panel {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-panel-lighter {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .glass-input {
            background: rgba(55, 65, 81, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .glass-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
            background: rgba(55, 65, 81, 0.8);
        }


        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        .result-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        /* Light Mode Styles */
        .light-mode {
            --bg-primary: #f2efe9;
            --bg-secondary: #ebe5dc;
            --bg-tertiary: #e0dacc;
            --text-primary: #2d2a26;
            --text-secondary: #5c574f;
            --text-muted: #8a847a;
            --border-color: rgba(45, 42, 38, 0.15);
            --glass-bg: rgba(242, 239, 233, 0.85);
            --glass-border: rgba(45, 42, 38, 0.12);
            --input-bg: rgba(225, 220, 210, 0.6);
        }

        .light-mode .glass-panel {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
        }

        .light-mode .glass-panel-lighter {
            background: rgba(235, 230, 222, 0.8);
            border: 1px solid var(--glass-border);
        }

        .light-mode .glass-input {
            background: var(--input-bg);
            border: 2px solid var(--glass-border);
            color: var(--text-primary);
        }

        .light-mode .glass-input:focus {
            border-color: #7c6f5a;
            box-shadow: 0 0 0 4px rgba(124, 111, 90, 0.15);
            background: rgba(235, 229, 217, 0.9);
        }

        .light-mode .glass-input::placeholder {
            color: var(--text-muted);
        }

        .light-mode .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(45, 42, 38, 0.05);
        }

        .light-mode .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(45, 42, 38, 0.2);
        }

        .light-mode .result-card {
            background: linear-gradient(135deg, rgba(124, 111, 90, 0.08) 0%, rgba(168, 143, 108, 0.08) 100%);
            border: 1px solid rgba(124, 111, 90, 0.2);
        }
    </style>
</head>

<body class="bg-gray-900">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // Icons as simple SVG components
        const Bot = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="10" rx="2" /><circle cx="12" cy="5" r="2" /><path d="M12 7v4M8 15h.01M16 15h.01" /></svg>;
        const Cpu = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2" /><rect x="9" y="9" width="6" height="6" /><path d="M9 1v3M15 1v3M9 20v3M15 20v3M20 9h3M20 14h3M1 9h3M1 14h3" /></svg>;
        const Send = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" /></svg>;
        const BookOpen = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2zM22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" /></svg>;
        const Globe = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" /><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" /></svg>;
        const Sparkles = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3Z" /></svg>;
        const User = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></svg>;
        const Loader2 = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-6.219-8.56" /></svg>;
        const Menu = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><line x1="4" x2="20" y1="12" y2="12" /><line x1="4" x2="20" y1="6" y2="6" /><line x1="4" x2="20" y1="18" y2="18" /></svg>;
        const X = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12" /></svg>;
        const ChevronRight = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="m9 18 6-6-6-6" /></svg>;
        const ChevronLeft = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="m15 18-6-6 6-6" /></svg>;
        const GraduationCap = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M22 10v6M2 10l10-5 10 5-10 5z" /><path d="M6 12v5c3 3 9 3 12 0v-5" /></svg>;
        const ClipboardList = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect width="8" height="4" x="8" y="2" rx="1" ry="1" /><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><path d="M12 11h4M12 16h4M8 11h.01M8 16h.01" /></svg>;
        const FileText = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" x2="8" y1="13" y2="13" /><line x1="16" x2="8" y1="17" y2="17" /><line x1="10" x2="8" y1="9" y2="9" /></svg>;
        const MessageSquare = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" /></svg>;
        const Trophy = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18M4 22h16M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22M18 2H6v7a6 6 0 0 0 12 0V2Z" /></svg>;
        const MapPin = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" /><circle cx="12" cy="10" r="3" /></svg>;
        const Link = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></svg>;
        const Lightbulb = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5M9 18h6M10 22h4" /></svg>;
        const Upload = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" /></svg>;
        const Layers = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83ZM22 12.65l-8.58 3.9a2 2 0 0 1-1.66 0L3 12.65M22 17.65l-8.58 3.9a2 2 0 0 1-1.66 0L3 17.65" /></svg>;
        const Copy = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></svg>;
        const Check = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12" /></svg>;
        const Sun = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4" /><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41" /></svg>;
        const Moon = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" /></svg>;

        // API Config
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent`;
        const API_KEY = "YOUR_API_KEY_HERE";

        const MOCK_SYLLABUS = `--- Class 10 History: Rise of Nationalism ---
The rise of nationalism in Europe was primarily driven by the French Revolution (1789), which introduced 'liberty, equality, fraternity' and the nation-state concept.
Key figures: Giuseppe Garibaldi (unified southern Italy), Otto von Bismarck ('Blood and Iron' policy for German unification).

--- Physics: Newton's Laws ---
Newton's Second Law: F=ma, where acceleration is directly proportional to net force (F) and inversely proportional to mass (m).`;

        // Retry hook
        const useRetryableFetch = () => {
            return useCallback(async (url, options) => {
                for (let attempt = 0; attempt < 5; attempt++) {
                    try {
                        if (attempt > 0) await new Promise(r => setTimeout(r, Math.pow(2, attempt) * 1000 + Math.random() * 1000));
                        const response = await fetch(url, options);
                        if (!response.ok) {
                            if (response.status === 429 && attempt < 4) continue;
                            throw new Error(`HTTP ${response.status}`);
                        }
                        return await response.json();
                    } catch (e) { if (attempt === 4) throw e; }
                }
            }, []);
        };

        // Splash Screen
        const SplashScreen = ({ onComplete }) => {
            const [step, setStep] = useState(0);
            useEffect(() => {
                const t = [setTimeout(() => setStep(1), 500), setTimeout(() => setStep(2), 1500), setTimeout(() => setStep(3), 2500), setTimeout(onComplete, 3000)];
                return () => t.forEach(clearTimeout);
            }, [onComplete]);
            if (step === 3) return null;
            return (
                <div className={`fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-900 transition-opacity duration-700 ${step === 3 ? 'opacity-0' : 'opacity-100'}`}>
                    <div className="relative">
                        <div className="absolute inset-0 bg-indigo-500 rounded-full blur-3xl opacity-20 animate-pulse"></div>
                        <div className={`transition-all duration-1000 transform ${step >= 1 ? 'scale-100 opacity-100' : 'scale-50 opacity-0'}`}>
                            <div className="w-16 h-16 bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 rounded-2xl flex items-center justify-center shadow-2xl animate-float">
                                <Cpu className="w-8 h-8 text-white" />
                            </div>
                        </div>
                    </div>
                    <h1 className={`mt-8 text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-300 tracking-wider transition-all duration-1000 transform ${step >= 2 ? 'translate-y-0 opacity-100' : 'translate-y-10 opacity-0'}`}>
                        ATLAS PREMIUM PLATFORM
                    </h1>
                    <p className={`mt-2 text-gray-400 text-sm tracking-widest uppercase transition-all duration-1000 delay-300 transform ${step >= 2 ? 'opacity-100' : 'opacity-0'}`}>
                        Adaptive Learning Intelligence
                    </p>
                </div>
            );
        };

        // Doubt Solver Component
        const DoubtSolver = ({ retryableFetch, isDarkMode }) => {
            const [messages, setMessages] = useState([{ role: 'model', text: "Hello! I am ATLAS. I'm ready to help with your studies. Use the toggle above to switch between Syllabus RAG and General AI modes.", grounded: false }]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [isRagMode, setIsRagMode] = useState(true);
            const messagesEndRef = useRef(null);

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, isLoading]);

            const handleSendMessage = async (e) => {
                if (e) e.preventDefault();
                if (!input.trim() || isLoading) return;
                const userMessage = input.trim();
                setInput('');
                setMessages(prev => [...prev, { role: 'user', text: userMessage }]);
                setIsLoading(true);

                let systemPrompt = isRagMode
                    ? `You are ATLAS, an elite educational assistant. 
                       Your goal is to explain concepts clearly using the provided syllabus.
                       
                       CRITICAL INSTRUCTIONS:
                       1. Format your answer in plain, readable text. Avoid using markdown headers (#) or excessive bold/italic formatting.
                       2. Use simple bullet points (- ) for lists when needed.
                       3. Use line breaks to separate ideas for readability.
                       4. Be Concise but Thorough: Explain the 'Why' and 'How'.
                       5. Tone: Inspiring, Professional, and Helpful.
                       6. Context: Only use this CURRICULUM CONTEXT:
                       ---
                       ${MOCK_SYLLABUS}
                       ---
                       Student Query: "${userMessage}"`
                    : `You are ATLAS, a helpful and intelligent AI assistant. 
                       Instructions:
                       - Answer accurately and clearly in plain text.
                       - Avoid using markdown headers (#) or excessive bold/italic formatting (*).
                       - Use simple bullet points and line breaks for structure.
                       - Be engaging and supportive.`;

                try {
                    const payload = { contents: [{ parts: [{ text: userMessage }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
                    const result = await retryableFetch(API_URL + `?key=${API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "I apologize, I could not generate a response.";
                    setMessages(prev => [...prev, { role: 'model', text, grounded: isRagMode }]);
                } catch (err) {
                    setMessages(prev => [...prev, { role: 'model', text: "Error: " + err.message, grounded: false }]);
                } finally { setIsLoading(false); }
            };

            return (
                <div className={`flex flex-col h-full ${isDarkMode ? 'bg-gray-900 text-white' : 'bg-[#faf8f5] text-[#2d2a26]'} relative overflow-hidden`}>
                    <div className={`absolute -top-20 -right-20 w-96 h-96 ${isDarkMode ? 'bg-purple-600/30' : 'bg-amber-400/20'} rounded-full blur-3xl -z-10 pointer-events-none`} />

                    <div className={`px-8 py-5 glass-panel sticky top-0 z-20 flex flex-col sm:flex-row sm:items-center justify-between gap-4 shadow-xl ${!isDarkMode && 'border-[#e5dfd3]'}`}>
                        <div>
                            <h2 className={`text-2xl font-bold ${isDarkMode ? 'text-white' : 'text-[#2d2a26]'} flex items-center`}><Sparkles className="w-6 h-6 mr-2 text-indigo-400" /> ATLAS Doubt Solver</h2>
                            <p className={`text-sm ${isDarkMode ? 'text-slate-400' : 'text-[#8a847a]'}`}>Adaptive Learning Intelligence</p>
                        </div>
                        <div className={`flex glass-panel-lighter p-1.5 rounded-full ${isDarkMode ? 'border-white/20' : 'border-[#e5dfd3]'} border`}>
                            <button onClick={() => setIsRagMode(true)} className={`flex items-center px-4 py-2 rounded-full text-xs font-bold transition-all ${isRagMode ? 'bg-indigo-600 text-white shadow-lg' : isDarkMode ? 'text-slate-400 hover:text-white' : 'text-[#8a847a] hover:text-[#2d2a26]'}`}>
                                <BookOpen className="w-3.5 h-3.5 mr-2" /> Syllabus RAG
                            </button>
                            <button onClick={() => setIsRagMode(false)} className={`flex items-center px-4 py-2 rounded-full text-xs font-bold transition-all ${!isRagMode ? 'bg-emerald-600 text-white shadow-lg' : isDarkMode ? 'text-slate-400 hover:text-white' : 'text-[#8a847a] hover:text-[#2d2a26]'}`}>
                                <Globe className="w-3.5 h-3.5 mr-2" /> General AI
                            </button>
                        </div>
                    </div>

                    {isRagMode && (
                        <div className={`px-8 py-2 ${isDarkMode ? 'bg-indigo-900/50 border-indigo-700/50' : 'bg-indigo-100 border-indigo-200'} border-b animate-slide-up`}>
                            <details className="group">
                                <summary className={`cursor-pointer text-xs font-bold ${isDarkMode ? 'text-indigo-400' : 'text-indigo-600'} flex items-center`}>
                                    <div className='w-2 h-2 rounded-full bg-indigo-500 mr-2 animate-pulse'></div>
                                    Active Context: Class 10 History & Physics <ChevronRight className="w-3 h-3 ml-1 group-open:rotate-90 transition-transform" />
                                </summary>
                                <div className={`mt-3 p-4 glass-panel-lighter rounded-xl text-xs font-mono ${isDarkMode ? 'text-slate-300' : 'text-[#5c574f]'} whitespace-pre-wrap max-h-40 overflow-y-auto custom-scrollbar`}>{MOCK_SYLLABUS}</div>
                            </details>
                        </div>
                    )}

                    <div className="flex-1 overflow-y-auto p-4 sm:p-8 space-y-6 custom-scrollbar">
                        {messages.map((msg, i) => (
                            <div key={i} className={`flex w-full animate-message ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] sm:max-w-[70%] p-5 rounded-2xl shadow-xl ${msg.role === 'user' ? 'bg-gradient-to-br from-indigo-600 to-violet-600 text-white rounded-br-none' : isDarkMode ? 'glass-panel-lighter text-slate-200 rounded-tl-none border border-white/10' : 'bg-white text-[#2d2a26] rounded-tl-none border border-[#e5dfd3] shadow-md'}`}>
                                    <div className={`font-bold text-[10px] mb-2 uppercase tracking-wider flex items-center ${msg.role === 'user' ? 'text-indigo-100' : isDarkMode ? 'text-slate-400' : 'text-[#8a847a]'}`}>
                                        {msg.role === 'user' ? <><User className="w-3 h-3 mr-1.5" />You</> : <><Bot className="w-3 h-3 mr-1.5" />ATLAS AI</>}
                                    </div>
                                    <div className="whitespace-pre-wrap leading-7 text-sm">{msg.text}</div>
                                    {msg.role === 'model' && <div className={`mt-3 pt-3 ${isDarkMode ? 'border-white/10' : 'border-[#e5dfd3]'} border-t text-[10px] flex items-center font-bold uppercase ${msg.grounded ? 'text-indigo-400' : 'text-emerald-500'}`}>
                                        {msg.grounded ? <><BookOpen className="w-3 h-3 mr-1.5" />Syllabus Verified</> : <><Globe className="w-3 h-3 mr-1.5" />General Knowledge</>}
                                    </div>}
                                </div>
                            </div>
                        ))}
                        {isLoading && <div className="flex justify-start animate-pulse"><div className={`glass-panel-lighter p-4 rounded-2xl rounded-tl-none ${isDarkMode ? 'border-white/10' : 'border-[#e5dfd3] bg-white'} border flex items-center space-x-3`}><Loader2 className="w-5 h-5 animate-spin text-indigo-400" /><span className={`text-xs ${isDarkMode ? 'text-slate-400' : 'text-[#8a847a]'} font-bold`}>ANALYZING...</span></div></div>}
                        <div ref={messagesEndRef} />
                    </div>

                    <div className={`p-6 glass-panel ${isDarkMode ? 'border-white/10' : 'border-[#e5dfd3]'} border-t`}>
                        <form onSubmit={handleSendMessage} className="flex gap-3 max-w-5xl mx-auto relative">
                            <input type="text" value={input} onChange={(e) => setInput(e.target.value)} placeholder={isRagMode ? "Ask a syllabus question..." : "Ask anything..."} className={`flex-grow p-4 pl-6 pr-14 ${isDarkMode ? 'bg-gray-800 focus:bg-gray-700 text-white placeholder:text-slate-500' : 'bg-white focus:bg-white text-[#2d2a26] placeholder:text-[#8a847a] border-[#e5dfd3]'} border-2 border-transparent rounded-2xl focus:border-indigo-500 outline-none font-medium`} disabled={isLoading} />
                            <button type="submit" className="absolute right-2 top-2 bottom-2 aspect-square rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 transition-all shadow-lg flex items-center justify-center disabled:opacity-50" disabled={isLoading || !input.trim()}>
                                <Send className="h-5 w-5" />
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // College Compass Component (Integrated from college finder)
        const CollegeCompass = ({ retryableFetch, isDarkMode }) => {
            const [activeTab, setActiveTab] = useState('structured');
            const [formData, setFormData] = useState({ gpa: '', major: '', extracurriculars: '', location: '' });
            const [chatInput, setChatInput] = useState('');
            const [chatHistory, setChatHistory] = useState([{ role: 'model', text: "Hello! I'm your AI College Counselor. Ask me anything about university admissions, programs, or career paths. I use real-time data to give you accurate recommendations." }]);
            const [structuredResult, setStructuredResult] = useState('');
            const [citations, setCitations] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [showIntro, setShowIntro] = useState(true);
            const chatEndRef = useRef(null);

            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [chatHistory]);
            useEffect(() => { const timer = setTimeout(() => setShowIntro(false), 800); return () => clearTimeout(timer); }, []);

            const handleInputChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });

            const handleStructuredSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setStructuredResult('');
                setCitations([]);

                const userQuery = `
                    Analyze the following student profile and provide a detailed college recommendation.
                    1. Recommend 2 'Safety/Good Fit' colleges, 2 'Target' colleges, and 1 'Reach' college.
                    2. For each recommendation, state the estimated chance of acceptance (High, Medium, Low).
                    3. Justify the recommendation based on the profile and real-world acceptance data.
                    4. Use the current year's data for all metrics.

                    --- STUDENT PROFILE ---
                    GPA/Marks: ${formData.gpa}
                    Desired Major: ${formData.major}
                    Extracurriculars: ${formData.extracurriculars}
                    Preferred Location: ${formData.location || 'No strong preference'}
                    --- END PROFILE ---
                `;

                try {
                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        tools: [{ "google_search": {} }],
                        systemInstruction: { parts: [{ text: "You are a world-class College Admissions Counselor. Your response must be detailed and based on verified data. Avoid using markdown headers (#) or excessive bold/italic formatting (*). Use simple bullet points and line breaks for structure. Be professional and encouraging." }] }
                    };
                    const result = await retryableFetch(API_URL + `?key=${API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "No recommendation generated.";
                    const sources = result.candidates?.[0]?.groundingMetadata?.groundingAttributions?.map(a => ({ uri: a.web?.uri, title: a.web?.title })).filter(s => s.uri && s.title) || [];
                    setStructuredResult(text);
                    setCitations(sources);
                } catch (err) {
                    setStructuredResult("Error: " + err.message);
                } finally { setIsLoading(false); }
            };

            const handleChatSubmit = async (e) => {
                e.preventDefault();
                if (!chatInput.trim()) return;
                const userMsg = chatInput.trim();
                setChatInput('');
                setChatHistory(prev => [...prev, { role: 'user', text: userMsg }]);
                setIsLoading(true);

                const historyPayload = chatHistory.map(m => ({ role: m.role === 'user' ? 'user' : 'model', parts: [{ text: m.text }] }));
                historyPayload.push({ role: 'user', parts: [{ text: userMsg }] });

                try {
                    const payload = {
                        contents: historyPayload,
                        tools: [{ "google_search": {} }],
                        systemInstruction: { parts: [{ text: "You are a friendly College Counselor AI. Provide concise answers grounded in data. Avoid markdown headers (#) or excessive bold formatting (*). Use simple bullet points and line breaks for readability." }] }
                    };
                    const result = await retryableFetch(API_URL + `?key=${API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "I couldn't find an answer.";
                    setChatHistory(prev => [...prev, { role: 'model', text }]);
                } catch (err) {
                    setChatHistory(prev => [...prev, { role: 'model', text: "Sorry, I encountered an error." }]);
                } finally { setIsLoading(false); }
            };

            return (
                <div className={`flex flex-col h-full ${isDarkMode ? 'bg-gray-900 text-white' : 'bg-[#faf8f5] text-[#2d2a26]'} relative overflow-y-auto custom-scrollbar`}>
                    {/* Floating decorations */}
                    <div className={`absolute top-0 right-0 w-[500px] h-[500px] ${isDarkMode ? 'bg-blue-600/20' : 'bg-blue-300/20'} rounded-full blur-3xl -z-10 pointer-events-none animate-pulse`} />
                    <div className={`absolute bottom-0 left-0 w-[400px] h-[400px] ${isDarkMode ? 'bg-cyan-600/20' : 'bg-cyan-300/20'} rounded-full blur-3xl -z-10 pointer-events-none`} />

                    {/* Header with animation */}
                    <div className={`p-8 text-center glass-panel ${isDarkMode ? 'border-white/10' : 'border-[#e5dfd3]'} border-b shadow-xl sticky top-0 z-20 ${showIntro ? 'animate-slide-up' : ''}`}>
                        <h2 className={`text-3xl font-extrabold ${isDarkMode ? 'text-white' : 'text-[#2d2a26]'} flex justify-center items-center tracking-tight mb-2`}>
                            <span className="text-4xl mr-3">ðŸŽ“</span>
                            <span className="bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">College Finder AI</span>
                        </h2>
                        <p className={`text-sm font-medium ${isDarkMode ? 'text-slate-400' : 'text-[#8a847a]'} uppercase tracking-widest`}>Find your perfect educational path using data and conversational AI</p>
                    </div>

                    <div className="p-4 md:p-8 max-w-5xl mx-auto w-full flex-1 flex flex-col">
                        {/* Tabs with animation */}
                        <div className={`flex mb-8 glass-panel-lighter p-1.5 rounded-2xl shadow-lg ${isDarkMode ? 'border-white/10' : 'border-[#e5dfd3]'} border ${showIntro ? 'animate-slide-up-delay-1' : ''}`}>
                            <button onClick={() => setActiveTab('structured')} className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all duration-300 flex items-center justify-center ${activeTab === 'structured' ? 'bg-gradient-to-r from-blue-600 to-cyan-600 text-white shadow-lg shadow-blue-500/30' : isDarkMode ? 'text-slate-400 hover:text-white hover:bg-white/10' : 'text-[#8a847a] hover:text-[#2d2a26] hover:bg-[#ebe5d9]'}`}>
                                <ClipboardList className="w-4 h-4 mr-2" /> Structured Profile Input
                            </button>
                            <button onClick={() => setActiveTab('chat')} className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all duration-300 flex items-center justify-center ${activeTab === 'chat' ? 'bg-gradient-to-r from-blue-600 to-cyan-600 text-white shadow-lg shadow-blue-500/30' : isDarkMode ? 'text-slate-400 hover:text-white hover:bg-white/10' : 'text-[#8a847a] hover:text-[#2d2a26] hover:bg-[#ebe5d9]'}`}>
                                <MessageSquare className="w-4 h-4 mr-2" /> Conversational Chat
                            </button>
                        </div>

                        {activeTab === 'structured' ? (
                            <div className={`space-y-8 ${showIntro ? 'animate-slide-up-delay-2' : 'animate-fade-in'}`}>
                                {/* Form */}
                                <form onSubmit={handleStructuredSubmit} className={`glass-panel p-8 rounded-3xl shadow-xl ${isDarkMode ? 'border-white/10' : 'border-[#e5dfd3]'} border space-y-6 relative overflow-hidden group`}>
                                    <div className="absolute top-0 left-0 w-2 h-full bg-gradient-to-b from-blue-500 to-cyan-500" />

                                    <h3 className={`text-xl font-bold ${isDarkMode ? 'text-white border-white/10' : 'text-[#2d2a26] border-[#e5dfd3]'} mb-4 border-b pb-3 flex items-center`}>
                                        <i className="fas fa-user-graduate mr-3 text-blue-400"></i>Your Academic Profile
                                    </h3>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className='space-y-2'>
                                            <label className={`text-xs font-bold ${isDarkMode ? 'text-slate-400' : 'text-[#8a847a]'} uppercase tracking-wider ml-1 flex items-center`}>
                                                <i className="fas fa-graduation-cap mr-2 text-blue-400"></i>GPA / Marks
                                            </label>
                                            <input name="gpa" value={formData.gpa} onChange={handleInputChange} required placeholder="e.g., 3.8/4.0 or 95%"
                                                className={`w-full p-4 rounded-xl glass-input ${isDarkMode ? 'text-white placeholder:text-slate-500' : 'text-[#2d2a26] placeholder:text-[#8a847a]'} focus:outline-none`} />
                                        </div>
                                        <div className='space-y-2'>
                                            <label className={`text-xs font-bold ${isDarkMode ? 'text-slate-400' : 'text-[#8a847a]'} uppercase tracking-wider ml-1 flex items-center`}>
                                                <i className="fas fa-book mr-2 text-blue-400"></i>Target Major
                                            </label>
                                            <input name="major" value={formData.major} onChange={handleInputChange} required placeholder="e.g., Computer Science"
                                                className={`w-full p-4 rounded-xl glass-input ${isDarkMode ? 'text-white placeholder:text-slate-500' : 'text-[#2d2a26] placeholder:text-[#8a847a]'} focus:outline-none`} />
                                        </div>
                                    </div>

                                    <div className='space-y-2'>
                                        <label className={`text-xs font-bold ${isDarkMode ? 'text-slate-400' : 'text-[#8a847a]'} uppercase tracking-wider ml-1 flex items-center`}>
                                            <i className="fas fa-trophy mr-2 text-yellow-400"></i>Extracurriculars & Achievements
                                        </label>
                                        <textarea name="extracurriculars" value={formData.extracurriculars} onChange={handleInputChange} required rows="4" placeholder="Leadership roles, sports, volunteering, projects..."
                                            className={`w-full p-4 rounded-xl glass-input ${isDarkMode ? 'text-white placeholder:text-slate-500' : 'text-[#2d2a26] placeholder:text-[#8a847a]'} focus:outline-none resize-none`} />
                                    </div>

                                    <div className='space-y-2'>
                                        <label className={`text-xs font-bold ${isDarkMode ? 'text-slate-400' : 'text-[#8a847a]'} uppercase tracking-wider ml-1 flex items-center`}>
                                            <i className="fas fa-map-marker-alt mr-2 text-red-400"></i>Preferred Location
                                        </label>
                                        <input name="location" value={formData.location} onChange={handleInputChange} placeholder="e.g., USA, Europe, or a specific city"
                                            className={`w-full p-4 rounded-xl glass-input ${isDarkMode ? 'text-white placeholder:text-slate-500' : 'text-[#2d2a26] placeholder:text-[#8a847a]'} focus:outline-none`} />
                                    </div>

                                    <button type="submit" disabled={isLoading} className="w-full py-4 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-xl font-bold text-lg shadow-xl shadow-blue-500/20 hover:shadow-2xl hover:scale-[1.01] transition-all flex justify-center items-center disabled:opacity-50 disabled:scale-100">
                                        {isLoading ? <><Loader2 className="animate-spin w-6 h-6 mr-2" />Analyzing Profile...</> : <><i className="fas fa-magic mr-2"></i>Get My College Recommendations</>}
                                    </button>
                                </form>

                                {/* Results */}
                                {structuredResult && (
                                    <div className={`${isDarkMode ? 'result-card' : 'bg-white border-[#e5dfd3]'} p-8 rounded-3xl shadow-2xl border animate-slide-up relative overflow-hidden`}>
                                        <h3 className="text-2xl font-bold text-blue-400 mb-6 flex items-center border-b border-blue-500/30 pb-4">
                                            <Lightbulb className="w-7 h-7 mr-3 text-yellow-400" />
                                            AI Recommendation
                                        </h3>
                                        <div className={`prose max-w-none ${isDarkMode ? 'prose-invert text-slate-300' : 'text-[#5c574f]'} leading-relaxed whitespace-pre-wrap`}>
                                            {structuredResult}
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : (
                            /* Chat Mode */
                            <div className={`flex-1 flex flex-col glass-panel rounded-3xl shadow-xl ${isDarkMode ? 'border-white/10' : 'border-[#e5dfd3]'} border overflow-hidden h-[600px] relative ${showIntro ? 'animate-slide-up-delay-2' : 'animate-fade-in'}`}>
                                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 via-cyan-500 to-blue-400" />

                                <div className="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar">
                                    {chatHistory.map((msg, i) => (
                                        <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} ${msg.role === 'user' ? 'animate-slide-in-right' : 'animate-slide-in-left'}`}>
                                            <div className={`max-w-[80%] p-4 rounded-2xl shadow-lg text-sm leading-6 ${msg.role === 'user' ? 'bg-gradient-to-tr from-blue-600 to-cyan-600 text-white rounded-br-none' : isDarkMode ? 'glass-panel-lighter text-slate-200 border border-white/10 rounded-tl-none' : 'bg-white text-[#2d2a26] border border-[#e5dfd3] rounded-tl-none'}`}>
                                                <span className="opacity-70 mr-2">{msg.role === 'user' ? <i className="fas fa-user"></i> : <i className="fas fa-robot"></i>}</span>
                                                {msg.text}
                                            </div>
                                        </div>
                                    ))}
                                    {isLoading && (
                                        <div className="flex justify-start animate-slide-in-left">
                                            <div className={`glass-panel-lighter p-4 rounded-2xl rounded-tl-none ${isDarkMode ? 'border-white/10' : 'border-[#e5dfd3] bg-white'} border shadow-sm flex items-center gap-2`}>
                                                <Loader2 className="w-5 h-5 animate-spin text-blue-400" />
                                                <span className={`${isDarkMode ? 'text-slate-400' : 'text-[#8a847a]'} text-sm`}>Thinking...</span>
                                            </div>
                                        </div>
                                    )}
                                    <div ref={chatEndRef} />
                                </div>

                                <form onSubmit={handleChatSubmit} className={`p-4 glass-panel ${isDarkMode ? 'border-white/10' : 'border-[#e5dfd3]'} border-t flex gap-3 items-center`}>
                                    <input value={chatInput} onChange={(e) => setChatInput(e.target.value)} placeholder="Ask about colleges, admissions, career paths..." className={`flex-1 p-4 rounded-xl ${isDarkMode ? 'bg-gray-800 border-gray-700 focus:bg-gray-700 text-white placeholder:text-slate-500' : 'bg-white border-[#e5dfd3] focus:bg-white text-[#2d2a26] placeholder:text-[#8a847a]'} border focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none`} disabled={isLoading} />
                                    <button type="submit" disabled={isLoading || !chatInput.trim()} className="p-4 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-xl shadow-lg hover:shadow-xl transition active:scale-95 disabled:opacity-50">
                                        <Send className="w-5 h-5" />
                                    </button>
                                </form>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Quiz Assessment Component - Advanced AI Version
        const QuizAssessment = ({ retryableFetch, isDarkMode }) => {
            const [step, setStep] = useState('setup'); // setup, taking, grading, result
            const [config, setConfig] = useState({ subject: '', topic: '', difficulty: 'Medium', length: 'Full', type: 'Both' });
            const [quizData, setQuizData] = useState(null);
            const [answers, setAnswers] = useState({});
            const [gradingResult, setGradingResult] = useState(null);
            const [videoRecs, setVideoRecs] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);

            const handleConfigChange = (e) => setConfig({ ...config, [e.target.name]: e.target.value });

            // Generate Quiz
            const generateQuiz = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setError(null);

                const qCount = config.length === 'Rapid' ? (config.type === 'Both' ? 5 : 5) : (config.type === 'Both' ? 10 : 10);

                const prompt = `
                    Generate a ${config.length} ${config.difficulty} level quiz for ${config.subject} on the topic: "${config.topic}".
                    Format: JSON only.
                    Structure:
                    {
                        "title": "Quiz Title",
                        "questions": [
                            {
                                "id": 1,
                                "type": "objective" (or "subjective"),
                                "question": "Question text",
                                "options": ["A", "B", "C", "D"], // if objective
                                "correctAnswer": "Option text" // if objective
                            }
                        ]
                    }
                    Requirements:
                    - Total Questions: ${qCount}
                    - Type: ${config.type} (If 'Both', mix objective and subjective)
                    - Ensure questions test deep understanding.
                `;

                try {
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    };
                    const result = await retryableFetch(API_URL + `?key=${API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    const cleanText = text.replace(/```json|```/g, '').trim();
                    try {
                        setQuizData(JSON.parse(cleanText));
                        setStep('taking');
                    } catch (parseError) {
                        console.error("JSON Parse Error:", parseError, text);
                        setError("Failed to parse quiz data. Try again.");
                    }
                } catch (err) {
                    setError("Failed to generate quiz. Please try again.");
                } finally { setIsLoading(false); }
            };

            // Submit Quiz for Grading
            const submitQuiz = async () => {
                setIsLoading(true);
                setStep('grading'); // Show loading state

                const submissionData = quizData.questions.map(q => ({
                    question: q.question,
                    correctAnswer: q.correctAnswer || "Subjective - Model Eval",
                    studentAnswer: answers[q.id] || "No Answer",
                    type: q.type
                }));

                const prompt = `
                    Act as an expert tutor. Grade this student's quiz submission.
                    
                    Quiz Topic: ${config.topic} (${config.subject})
                    Difficulty: ${config.difficulty}

                    Submission Data:
                    ${JSON.stringify(submissionData)}

                    Task:
                    1. Analyze the student's performance.
                    2. Provide a score (e.g., 8/10).
                    3. Identify Specific Weak Areas.
                    4. Suggest 3 concrete ways to improve.
                    5. Recommend YouTube search terms for the weak topics.
                    
                    Format your response in plain text without markdown headers (#) or excessive bold/italic (*). Use simple bullet points and line breaks. Be encouraging but rigorous.
                `;

                try {
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        tools: [{ "google_search": {} }] // For grounding recommendations
                    };
                    const result = await retryableFetch(API_URL + `?key=${API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    // Extract YouTube/Video links if present in grounding metadata
                    const videos = result.candidates?.[0]?.groundingMetadata?.groundingAttributions
                        ?.filter(a => a.web?.uri?.includes('youtube.com') || a.web?.title?.includes('Video'))
                        ?.map(a => ({ title: a.web.title, uri: a.web.uri })) || [];

                    setGradingResult(text);
                    setVideoRecs(videos);
                    setStep('result');
                } catch (err) {
                    setError("grading failed: " + err.message);
                } finally { setIsLoading(false); }
            };

            return (
                <div className={`flex flex-col h-full ${isDarkMode ? 'bg-gray-900 text-white' : 'bg-[#faf8f5] text-[#2d2a26]'} relative overflow-y-auto custom-scrollbar p-4 md:p-8`}>
                    <div className={`absolute top-0 right-0 w-[600px] h-[600px] ${isDarkMode ? 'bg-purple-900/20' : 'bg-purple-300/20'} rounded-full blur-[100px] -z-10 pointer-events-none`} />
                    <div className={`absolute bottom-0 left-0 w-[500px] h-[500px] ${isDarkMode ? 'bg-indigo-900/20' : 'bg-indigo-300/20'} rounded-full blur-[100px] -z-10 pointer-events-none`} />

                    {step === 'setup' && (
                        <div className="max-w-4xl mx-auto w-full animate-slide-up">
                            <div className={`glass-panel p-8 rounded-3xl shadow-2xl ${isDarkMode ? 'border-white/10' : 'border-[#e5dfd3]'} border relative overflow-hidden`}>
                                <div className="absolute top-0 left-0 w-2 h-full bg-gradient-to-b from-purple-500 to-pink-500" />
                                <h2 className={`text-3xl font-bold mb-6 flex items-center ${isDarkMode ? 'text-white' : 'text-[#2d2a26]'}`}><FileText className="w-8 h-8 mr-3 text-purple-400" /> Quiz Configuration</h2>

                                <form onSubmit={generateQuiz} className="space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="space-y-2">
                                            <label className="text-sm font-bold text-slate-400 uppercase tracking-wider">Subject</label>
                                            <input name="subject" value={config.subject} onChange={handleConfigChange} required placeholder="e.g. Physics, History" className="w-full p-4 rounded-xl glass-input text-white focus:outline-none" />
                                        </div>
                                        <div className="space-y-2">
                                            <label className="text-sm font-bold text-slate-400 uppercase tracking-wider">Chapter / Topic</label>
                                            <input name="topic" value={config.topic} onChange={handleConfigChange} required placeholder="e.g. Newton's Laws" className="w-full p-4 rounded-xl glass-input text-white focus:outline-none" />
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        {['Easy', 'Medium', 'Hard'].map(d => (
                                            <label key={d} className={`p-4 rounded-xl border cursor-pointer transition-all ${config.difficulty === d ? 'bg-purple-600/20 border-purple-500 text-purple-300' : 'border-white/10 hover:bg-white/5'}`}>
                                                <input type="radio" name="difficulty" value={d} checked={config.difficulty === d} onChange={handleConfigChange} className="hidden" />
                                                <div className="font-bold text-center">{d}</div>
                                            </label>
                                        ))}
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <label className={`p-4 rounded-xl border cursor-pointer transition-all ${config.length === 'Rapid' ? 'bg-pink-600/20 border-pink-500 text-pink-300' : 'border-white/10 hover:bg-white/5'}`}>
                                            <input type="radio" name="length" value="Rapid" checked={config.length === 'Rapid'} onChange={handleConfigChange} className="hidden" />
                                            <div className="font-bold text-center">âš¡ Rapid Fire (5 Qs)</div>
                                        </label>
                                        <label className={`p-4 rounded-xl border cursor-pointer transition-all ${config.length === 'Full' ? 'bg-pink-600/20 border-pink-500 text-pink-300' : 'border-white/10 hover:bg-white/5'}`}>
                                            <input type="radio" name="length" value="Full" checked={config.length === 'Full'} onChange={handleConfigChange} className="hidden" />
                                            <div className="font-bold text-center">ðŸ“ Full Assessment (10 Qs)</div>
                                        </label>
                                    </div>

                                    <div className="flex gap-4">
                                        {['Objective', 'Subjective', 'Both'].map(t => (
                                            <label key={t} className={`flex-1 p-3 rounded-lg border cursor-pointer text-sm text-center transition-all ${config.type === t ? 'bg-indigo-600/20 border-indigo-500 text-indigo-300' : 'border-white/10 hover:bg-white/5'}`}>
                                                <input type="radio" name="type" value={t} checked={config.type === t} onChange={handleConfigChange} className="hidden" />
                                                {t}
                                            </label>
                                        ))}
                                    </div>

                                    <button type="submit" disabled={isLoading} className="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-purple-500/30 transition-all transform hover:scale-[1.01] disabled:opacity-50 flex justify-center items-center">
                                        {isLoading ? <><Loader2 className="animate-spin mr-2" /> Generating Quiz...</> : 'Start Assessment'}
                                    </button>
                                    {error && <div className="text-red-400 text-center mt-2">{error}</div>}
                                </form>
                            </div>
                        </div>
                    )}

                    {step === 'taking' && quizData && (
                        <div className="max-w-4xl mx-auto w-full animate-slide-up space-y-8">
                            <div className="glass-panel-lighter p-6 rounded-2xl flex justify-between items-center sticky top-0 z-30 backdrop-blur-xl border-b border-white/10">
                                <div>
                                    <h3 className="text-xl font-bold text-white">{quizData.title}</h3>
                                    <span className="text-slate-400 text-sm">Question {Object.keys(answers).length} / {quizData.questions.length} Answered</span>
                                </div>
                                <button onClick={submitQuiz} className="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-600 rounded-lg font-bold shadow-lg hover:shadow-green-500/20 transition-all">
                                    Submit Quiz
                                </button>
                            </div>

                            <div className="space-y-6">
                                {quizData.questions.map((q, i) => (
                                    <div key={q.id} className="glass-panel p-6 rounded-2xl border border-white/5">
                                        <div className="flex gap-4">
                                            <div className="flex-shrink-0 w-8 h-8 rounded-full bg-purple-500/20 text-purple-300 flex items-center justify-center font-bold border border-purple-500/30">
                                                {i + 1}
                                            </div>
                                            <div className="flex-1">
                                                <p className="text-lg font-medium text-slate-200 mb-4">{q.question}</p>

                                                {q.type === 'objective' ? (
                                                    <div className="space-y-3">
                                                        {q.options.map((opt, idx) => (
                                                            <label key={idx} className={`flex items-center p-4 rounded-xl border transition-all cursor-pointer ${answers[q.id] === opt ? 'bg-purple-600/20 border-purple-500' : 'border-white/10 hover:bg-white/5'}`}>
                                                                <input type="radio" name={`q-${q.id}`} value={opt} checked={answers[q.id] === opt} onChange={() => setAnswers({ ...answers, [q.id]: opt })} className="hidden" />
                                                                <div className={`w-5 h-5 rounded-full border mr-3 flex items-center justify-center ${answers[q.id] === opt ? 'border-purple-400' : 'border-slate-500'}`}>
                                                                    {answers[q.id] === opt && <div className="w-2.5 h-2.5 rounded-full bg-purple-400" />}
                                                                </div>
                                                                {opt}
                                                            </label>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <textarea
                                                        rows="4"
                                                        className="w-full glass-input p-4 rounded-xl text-white focus:outline-none"
                                                        placeholder="Type your answer here..."
                                                        value={answers[q.id] || ''}
                                                        onChange={(e) => setAnswers({ ...answers, [q.id]: e.target.value })}
                                                    />
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {(step === 'grading' || step === 'result') && (
                        <div className="max-w-4xl mx-auto w-full animate-slide-up space-y-6">
                            {isLoading && (
                                <div className="glass-panel p-12 rounded-3xl text-center">
                                    <Loader2 className="w-12 h-12 text-purple-400 animate-spin mx-auto mb-4" />
                                    <h3 className="text-xl font-bold">Analyzing Performance...</h3>
                                    <p className="text-slate-400">Comparing answers, finding learning gaps, and curating resources.</p>
                                </div>
                            )}

                            {!isLoading && gradingResult && (
                                <>
                                    <div className="glass-panel p-8 rounded-3xl border border-white/10 relative overflow-hidden">
                                        <div className="absolute top-0 left-0 w-2 h-full bg-gradient-to-b from-green-400 to-emerald-500" />
                                        <div className="absolute top-0 left-0 w-2 h-full bg-gradient-to-b from-green-400 to-emerald-500" />
                                        <h2 className="text-2xl font-bold mb-6 flex items-center"><User className="w-6 h-6 mr-3 text-green-400" /> Assessment Report</h2>
                                        <div className="prose prose-invert max-w-none text-slate-300 leading-relaxed whitespace-pre-wrap">
                                            {gradingResult}
                                        </div>
                                    </div>

                                    {videoRecs.length > 0 && (
                                        <div className="glass-panel p-8 rounded-3xl border border-white/10">
                                            <h3 className="text-xl font-bold mb-4 flex items-center"><Globe className="mr-3 text-red-400" /> Recommended Learning Resources</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                {videoRecs.map((v, i) => (
                                                    <a key={i} href={v.uri} target="_blank" className="block p-4 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 transition-all group">
                                                        <div className="font-bold text-red-300 group-hover:text-red-200 mb-1 truncate">{v.title}</div>
                                                        <div className="text-xs text-slate-500 truncate">{v.uri}</div>
                                                    </a>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    <button onClick={() => { setStep('setup'); setAnswers({}); setQuizData(null); }} className="w-full py-4 bg-white/10 hover:bg-white/20 rounded-xl font-bold border border-white/10 transition-all">
                                        Take Another Quiz
                                    </button>
                                </>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // Document Study Component
        const DocumentStudy = ({ retryableFetch, isDarkMode }) => {
            const [documentContent, setDocumentContent] = useState('');
            const [fileName, setFileName] = useState('');
            const [isDragging, setIsDragging] = useState(false);
            const [selectedAction, setSelectedAction] = useState(null);
            const [result, setResult] = useState('');
            const [flashcards, setFlashcards] = useState([]);
            const [flippedCards, setFlippedCards] = useState({});
            const [isLoading, setIsLoading] = useState(false);
            const [isPdfLoading, setIsPdfLoading] = useState(false);
            const [copied, setCopied] = useState(false);
            const [activeTab, setActiveTab] = useState('analysis');
            const [chatMessages, setChatMessages] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [isChatLoading, setIsChatLoading] = useState(false);
            const fileInputRef = useRef(null);
            const chatEndRef = useRef(null);

            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [chatMessages]);

            // Initialize PDF.js worker
            useEffect(() => {
                if (window.pdfjsLib) {
                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                }
            }, []);

            const handleDragOver = (e) => { e.preventDefault(); setIsDragging(true); };
            const handleDragLeave = (e) => { e.preventDefault(); setIsDragging(false); };

            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragging(false);
                const file = e.dataTransfer.files[0];
                if (file) processFile(file);
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) processFile(file);
            };

            // Extract text from PDF using PDF.js
            const extractPdfText = async (arrayBuffer) => {
                try {
                    const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let fullText = '';

                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += `--- Page ${i} ---\n${pageText}\n\n`;
                    }

                    return fullText.trim();
                } catch (error) {
                    console.error('PDF extraction error:', error);
                    return null;
                }
            };

            const processFile = async (file) => {
                setFileName(file.name);
                setChatMessages([]);
                setResult('');
                setFlashcards([]);

                if (file.type === 'application/pdf') {
                    setIsPdfLoading(true);
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const extractedText = await extractPdfText(arrayBuffer);

                        if (extractedText && extractedText.length > 50) {
                            setDocumentContent(extractedText);
                            setChatMessages([{ role: 'model', text: `I've loaded your PDF "${file.name}" with ${extractedText.length} characters of text. You can now ask me any questions about it, or use the analysis tools above!` }]);
                        } else {
                            setDocumentContent(`[PDF File: ${file.name}]\n\nThe PDF appears to be image-based or couldn't be fully parsed. Please paste the text content manually for best results.`);
                        }
                    } catch (error) {
                        setDocumentContent(`[PDF File: ${file.name}]\n\nError reading PDF. Please paste the text content manually.`);
                    } finally {
                        setIsPdfLoading(false);
                    }
                } else if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setDocumentContent(`[Image File: ${file.name}]\n\nImage uploaded. For text analysis, please paste the text content, or describe what you see in the image.`);
                    };
                    reader.readAsDataURL(file);
                } else {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setDocumentContent(e.target.result);
                        setChatMessages([{ role: 'model', text: `I've loaded your file "${file.name}". You can now ask me any questions about it!` }]);
                    };
                    reader.readAsText(file);
                }
            };

            const handleAction = async (action) => {
                if (!documentContent.trim()) return;
                setSelectedAction(action);
                setIsLoading(true);
                setResult('');
                setFlashcards([]);

                const prompts = {
                    summarize: `Summarize the following document concisely. List key points using simple bullet points (- ). Avoid markdown headers (#) or bold formatting (*).\n\nDocument:\n${documentContent}`,
                    explain: `Explain the concepts in the following document in detail. Use clear language suitable for a student. Include examples where helpful. Avoid markdown headers (#) or bold formatting (*). Use line breaks and simple bullet points for structure.\n\nDocument:\n${documentContent}`,
                    test: `Generate a practice test based on the following document. Include:\n- 5 multiple choice questions with 4 options each\n- 3 short answer questions\n\nFormat each MCQ with the question, options (A, B, C, D), and mark the correct answer. Avoid markdown headers (#) or bold formatting (*).\n\nDocument:\n${documentContent}`,
                    flashcards: `Generate 8 flashcards from the following document. Return ONLY valid JSON in this exact format (no markdown, no code blocks):\n[{"front": "Question or term", "back": "Answer or definition"}]\n\nDocument:\n${documentContent}`
                };

                try {
                    const isFlashcardRequest = action === 'flashcards';
                    const payload = {
                        contents: [{ parts: [{ text: prompts[action] }] }],
                        systemInstruction: { parts: [{ text: "You are ATLAS, an expert educational assistant. Provide clear, accurate, and helpful responses. Avoid markdown headers (#) or excessive bold/italic formatting (*). Use simple bullet points and line breaks for structure." }] },
                        ...(isFlashcardRequest && { generationConfig: { responseMimeType: "application/json" } })
                    };

                    const response = await retryableFetch(API_URL + `?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const text = response.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";

                    if (isFlashcardRequest) {
                        try {
                            const cleanText = text.replace(/```json|```/g, '').trim();
                            setFlashcards(JSON.parse(cleanText));
                        } catch {
                            setResult("Failed to parse flashcards. Please try again.");
                        }
                    } else {
                        setResult(text);
                    }
                } catch (err) {
                    setResult("Error: " + err.message);
                } finally { setIsLoading(false); }
            };

            // Chat functionality
            const handleChatSubmit = async (e) => {
                e.preventDefault();
                if (!chatInput.trim() || !documentContent.trim()) return;

                const userMessage = chatInput.trim();
                setChatInput('');
                setChatMessages(prev => [...prev, { role: 'user', text: userMessage }]);
                setIsChatLoading(true);

                try {
                    const payload = {
                        contents: [{ parts: [{ text: `Based on this document:\n\n${documentContent}\n\nUser question: ${userMessage}` }] }],
                        systemInstruction: { parts: [{ text: "You are ATLAS, an expert educational assistant helping a student understand a document. Answer questions about the document clearly and concisely. If the question is not related to the document, politely redirect. Avoid markdown headers (#) or bold formatting (*). Use simple language." }] }
                    };

                    const response = await retryableFetch(API_URL + `?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const text = response.candidates?.[0]?.content?.parts?.[0]?.text || "I couldn't generate a response.";
                    setChatMessages(prev => [...prev, { role: 'model', text }]);
                } catch (err) {
                    setChatMessages(prev => [...prev, { role: 'model', text: "Sorry, I encountered an error. Please try again." }]);
                } finally { setIsChatLoading(false); }
            };

            const toggleCard = (index) => {
                setFlippedCards(prev => ({ ...prev, [index]: !prev[index] }));
            };

            const copyToClipboard = () => {
                navigator.clipboard.writeText(result);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            const clearAll = () => {
                setDocumentContent('');
                setFileName('');
                setResult('');
                setFlashcards([]);
                setSelectedAction(null);
                setChatMessages([]);
            };

            return (
                <div className={`flex flex-col h-full ${isDarkMode ? 'bg-gray-900 text-white' : 'bg-[#faf8f5] text-[#2d2a26]'} relative overflow-y-auto custom-scrollbar`}>
                    <div className={`absolute top-0 right-0 w-[500px] h-[500px] ${isDarkMode ? 'bg-amber-600/20' : 'bg-amber-300/20'} rounded-full blur-3xl -z-10 pointer-events-none`} />
                    <div className={`absolute bottom-0 left-0 w-[400px] h-[400px] ${isDarkMode ? 'bg-orange-600/20' : 'bg-orange-300/20'} rounded-full blur-3xl -z-10 pointer-events-none`} />

                    {/* Header */}
                    <div className={`p-8 text-center glass-panel ${isDarkMode ? 'border-white/10' : 'border-[#e5dfd3]'} border-b shadow-xl sticky top-0 z-20`}>
                        <h2 className={`text-3xl font-extrabold ${isDarkMode ? 'text-white' : 'text-[#2d2a26]'} flex justify-center items-center tracking-tight mb-2`}>
                            <span className="text-4xl mr-3">ðŸ“š</span>
                            <span className="bg-gradient-to-r from-amber-400 to-orange-400 bg-clip-text text-transparent">Document Study</span>
                        </h2>
                        <p className={`text-sm font-medium ${isDarkMode ? 'text-slate-400' : 'text-[#8a847a]'} uppercase tracking-widest`}>Upload documents for AI-powered analysis & chat</p>
                    </div>

                    <div className="p-4 md:p-8 max-w-5xl mx-auto w-full flex-1 flex flex-col gap-6">
                        {/* Upload Zone */}
                        <div
                            className={`glass-panel p-6 rounded-3xl border-2 border-dashed transition-all cursor-pointer relative overflow-hidden ${isDragging ? 'border-amber-400 bg-amber-500/10' : 'border-white/20 hover:border-amber-400/50'}`}
                            onDragOver={handleDragOver}
                            onDragLeave={handleDragLeave}
                            onDrop={handleDrop}
                            onClick={() => fileInputRef.current?.click()}
                        >
                            <input
                                ref={fileInputRef}
                                type="file"
                                accept=".pdf,.txt,.md,.doc,.docx,image/*"
                                onChange={handleFileChange}
                                className="hidden"
                            />
                            <div className="text-center">
                                {isPdfLoading ? (
                                    <>
                                        <Loader2 className="w-10 h-10 mx-auto mb-3 text-amber-400 animate-spin" />
                                        <h3 className="text-lg font-bold text-white mb-1">Extracting PDF text...</h3>
                                        <p className="text-sm text-slate-400">This may take a moment</p>
                                    </>
                                ) : (
                                    <>
                                        <Upload className={`w-10 h-10 mx-auto mb-3 ${isDragging ? 'text-amber-400' : 'text-slate-400'}`} />
                                        <h3 className="text-lg font-bold text-white mb-1">
                                            {fileName ? fileName : 'Drop your PDF or file here'}
                                        </h3>
                                        <p className="text-sm text-slate-400">
                                            {fileName ? 'Click to change file' : 'or click to browse â€¢ PDF, Text files'}
                                        </p>
                                    </>
                                )}
                            </div>
                        </div>

                        {/* Text Input (collapsible when file loaded) */}
                        <details className="glass-panel rounded-3xl border border-white/10" open={!fileName}>
                            <summary className="p-4 cursor-pointer text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center">
                                <FileText className="w-4 h-4 mr-2 text-amber-400" />
                                {fileName ? 'View/Edit extracted content' : 'Or paste your content'}
                                <ChevronRight className="w-4 h-4 ml-auto" />
                            </summary>
                            <div className="px-4 pb-4">
                                <textarea
                                    value={documentContent}
                                    onChange={(e) => setDocumentContent(e.target.value)}
                                    placeholder="Paste your document text, notes, or any content you want to study..."
                                    rows="6"
                                    className="w-full glass-input p-4 rounded-xl text-white placeholder:text-slate-500 focus:outline-none resize-none text-sm"
                                />
                                {documentContent && (
                                    <div className="flex justify-between items-center mt-2">
                                        <span className="text-xs text-slate-500">{documentContent.length} characters loaded</span>
                                        <button onClick={clearAll} className="text-xs text-slate-400 hover:text-white transition">
                                            <X className="w-3 h-3 inline mr-1" /> Clear all
                                        </button>
                                    </div>
                                )}
                            </div>
                        </details>

                        {/* Tabs: Analysis vs Chat */}
                        {documentContent && (
                            <div className="flex glass-panel-lighter p-1.5 rounded-2xl border border-white/10">
                                <button
                                    onClick={() => setActiveTab('analysis')}
                                    className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all flex items-center justify-center ${activeTab === 'analysis' ? 'bg-gradient-to-r from-amber-600 to-orange-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}
                                >
                                    <FileText className="w-4 h-4 mr-2" /> Analysis Tools
                                </button>
                                <button
                                    onClick={() => setActiveTab('chat')}
                                    className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all flex items-center justify-center ${activeTab === 'chat' ? 'bg-gradient-to-r from-amber-600 to-orange-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}
                                >
                                    <MessageSquare className="w-4 h-4 mr-2" /> Ask Questions
                                </button>
                            </div>
                        )}

                        {/* Analysis Tab */}
                        {activeTab === 'analysis' && documentContent && (
                            <>
                                {/* Action Buttons */}
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <button
                                        onClick={() => handleAction('summarize')}
                                        disabled={!documentContent.trim() || isLoading}
                                        className={`p-4 rounded-2xl border transition-all flex flex-col items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed ${selectedAction === 'summarize' ? 'bg-amber-600/20 border-amber-500 text-amber-300' : 'border-white/10 hover:bg-white/5 hover:border-amber-400/50'}`}
                                    >
                                        <span className="text-2xl">ðŸ“</span>
                                        <span className="font-bold text-sm">Summarize</span>
                                    </button>
                                    <button
                                        onClick={() => handleAction('explain')}
                                        disabled={!documentContent.trim() || isLoading}
                                        className={`p-4 rounded-2xl border transition-all flex flex-col items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed ${selectedAction === 'explain' ? 'bg-amber-600/20 border-amber-500 text-amber-300' : 'border-white/10 hover:bg-white/5 hover:border-amber-400/50'}`}
                                    >
                                        <span className="text-2xl">ðŸ’¡</span>
                                        <span className="font-bold text-sm">Explain</span>
                                    </button>
                                    <button
                                        onClick={() => handleAction('test')}
                                        disabled={!documentContent.trim() || isLoading}
                                        className={`p-4 rounded-2xl border transition-all flex flex-col items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed ${selectedAction === 'test' ? 'bg-amber-600/20 border-amber-500 text-amber-300' : 'border-white/10 hover:bg-white/5 hover:border-amber-400/50'}`}
                                    >
                                        <span className="text-2xl">âœ…</span>
                                        <span className="font-bold text-sm">Generate Test</span>
                                    </button>
                                    <button
                                        onClick={() => handleAction('flashcards')}
                                        disabled={!documentContent.trim() || isLoading}
                                        className={`p-4 rounded-2xl border transition-all flex flex-col items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed ${selectedAction === 'flashcards' ? 'bg-amber-600/20 border-amber-500 text-amber-300' : 'border-white/10 hover:bg-white/5 hover:border-amber-400/50'}`}
                                    >
                                        <span className="text-2xl">ðŸŽ´</span>
                                        <span className="font-bold text-sm">Flashcards</span>
                                    </button>
                                </div>

                                {/* Loading State */}
                                {isLoading && (
                                    <div className="glass-panel p-10 rounded-3xl text-center animate-pulse">
                                        <Loader2 className="w-10 h-10 text-amber-400 animate-spin mx-auto mb-3" />
                                        <h3 className="text-lg font-bold">Processing your document...</h3>
                                        <p className="text-slate-400 text-sm">This may take a moment</p>
                                    </div>
                                )}

                                {/* Text Results */}
                                {result && !isLoading && (
                                    <div className="glass-panel p-6 rounded-3xl border border-white/10 relative overflow-hidden animate-slide-up">
                                        <div className="absolute top-0 left-0 w-2 h-full bg-gradient-to-b from-amber-500 to-orange-500" />
                                        <div className="flex justify-between items-start mb-3">
                                            <h3 className="text-lg font-bold text-amber-400 flex items-center">
                                                {selectedAction === 'summarize' && <><FileText className="w-5 h-5 mr-2" /> Summary</>}
                                                {selectedAction === 'explain' && <><Lightbulb className="w-5 h-5 mr-2" /> Explanation</>}
                                                {selectedAction === 'test' && <><ClipboardList className="w-5 h-5 mr-2" /> Practice Test</>}
                                            </h3>
                                            <button
                                                onClick={copyToClipboard}
                                                className="p-2 rounded-lg bg-white/5 hover:bg-white/10 transition-all text-slate-400 hover:text-white"
                                            >
                                                {copied ? <Check className="w-4 h-4 text-green-400" /> : <Copy className="w-4 h-4" />}
                                            </button>
                                        </div>
                                        <div className="prose prose-invert max-w-none text-slate-300 leading-relaxed whitespace-pre-wrap text-sm">
                                            {result}
                                        </div>
                                    </div>
                                )}

                                {/* Flashcards */}
                                {flashcards.length > 0 && !isLoading && (
                                    <div className="animate-slide-up">
                                        <h3 className="text-lg font-bold text-amber-400 flex items-center mb-4">
                                            <Layers className="w-5 h-5 mr-2" /> Flashcards
                                            <span className="ml-3 text-sm font-normal text-slate-400">(Click to flip)</span>
                                        </h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            {flashcards.map((card, i) => (
                                                <div
                                                    key={i}
                                                    onClick={() => toggleCard(i)}
                                                    className="glass-panel p-5 rounded-2xl border border-white/10 cursor-pointer hover:border-amber-400/50 transition-all min-h-[120px] flex items-center justify-center text-center relative overflow-hidden group"
                                                >
                                                    <div className="absolute top-2 left-2 w-6 h-6 rounded-full bg-amber-500/20 text-amber-400 flex items-center justify-center text-xs font-bold">
                                                        {i + 1}
                                                    </div>
                                                    <div className="absolute top-2 right-2 text-[10px] uppercase tracking-wider text-slate-500">
                                                        {flippedCards[i] ? 'Answer' : 'Question'}
                                                    </div>
                                                    <p className={`text-sm ${flippedCards[i] ? 'text-amber-300' : 'text-white'}`}>
                                                        {flippedCards[i] ? card.back : card.front}
                                                    </p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </>
                        )}

                        {/* Chat Tab */}
                        {activeTab === 'chat' && documentContent && (
                            <div className="glass-panel rounded-3xl border border-white/10 flex flex-col h-[500px] relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-amber-400 via-orange-500 to-amber-400" />

                                {/* Chat Messages */}
                                <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                                    {chatMessages.length === 0 && (
                                        <div className="text-center py-10 text-slate-400">
                                            <MessageSquare className="w-10 h-10 mx-auto mb-3 opacity-50" />
                                            <p className="text-sm">Ask any question about your document!</p>
                                        </div>
                                    )}
                                    {chatMessages.map((msg, i) => (
                                        <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} animate-message`}>
                                            <div className={`max-w-[85%] p-3 rounded-2xl text-sm leading-relaxed ${msg.role === 'user' ? 'bg-gradient-to-br from-amber-600 to-orange-600 text-white rounded-br-none' : 'glass-panel-lighter text-slate-200 border border-white/10 rounded-tl-none'}`}>
                                                <div className="text-[10px] font-bold uppercase tracking-wider mb-1 opacity-70">
                                                    {msg.role === 'user' ? 'You' : 'ATLAS'}
                                                </div>
                                                <div className="whitespace-pre-wrap">{msg.text}</div>
                                            </div>
                                        </div>
                                    ))}
                                    {isChatLoading && (
                                        <div className="flex justify-start">
                                            <div className="glass-panel-lighter p-3 rounded-2xl rounded-tl-none border border-white/10 flex items-center gap-2">
                                                <Loader2 className="w-4 h-4 animate-spin text-amber-400" />
                                                <span className="text-xs text-slate-400">Thinking...</span>
                                            </div>
                                        </div>
                                    )}
                                    <div ref={chatEndRef} />
                                </div>

                                {/* Chat Input */}
                                <form onSubmit={handleChatSubmit} className="p-3 glass-panel border-t border-white/10 flex gap-2">
                                    <input
                                        value={chatInput}
                                        onChange={(e) => setChatInput(e.target.value)}
                                        placeholder="Ask a question about your document..."
                                        className="flex-1 p-3 rounded-xl bg-gray-800 border border-gray-700 focus:ring-2 focus:ring-amber-500 focus:border-transparent outline-none text-white placeholder:text-slate-500 text-sm"
                                        disabled={isChatLoading}
                                    />
                                    <button
                                        type="submit"
                                        disabled={isChatLoading || !chatInput.trim()}
                                        className="p-3 bg-gradient-to-r from-amber-600 to-orange-600 text-white rounded-xl shadow-lg hover:shadow-xl transition disabled:opacity-50"
                                    >
                                        <Send className="w-4 h-4" />
                                    </button>
                                </form>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Main App
        const App = () => {
            const [currentView, setCurrentView] = useState('doubt-solver');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [isCollapsed, setIsCollapsed] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [isDarkMode, setIsDarkMode] = useState(() => {
                const saved = localStorage.getItem('atlas-theme');
                return saved ? saved === 'dark' : true;
            });
            const retryableFetch = useRetryableFetch();

            useEffect(() => { setTimeout(() => setIsLoading(false), 3000); }, []);

            useEffect(() => {
                localStorage.setItem('atlas-theme', isDarkMode ? 'dark' : 'light');
                document.body.className = isDarkMode ? 'bg-gray-900' : 'bg-[#faf8f5]';
            }, [isDarkMode]);
            const Sidebar = () => (
                <div className={`fixed inset-y-0 left-0 transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 transition-all duration-300 ease-in-out ${isDarkMode ? 'bg-gray-900 text-slate-300 border-gray-700/50' : 'bg-[#f5f0e8] text-[#5c574f] border-[#e5dfd3]'} z-50 shadow-2xl flex flex-col border-r ${isCollapsed ? 'md:w-20' : 'md:w-72 w-72'}`}>
                    <div className={`p-4 ${isCollapsed ? 'py-4 px-3' : 'py-8 px-5'} flex items-center justify-between border-b ${isDarkMode ? 'border-gray-800/50' : 'border-[#e5dfd3]'}`}>
                        <h1 className={`text-2xl font-black tracking-tighter ${isDarkMode ? 'text-white' : 'text-[#2d2a26]'} flex items-center ${isCollapsed ? 'justify-center' : ''}`}>
                            <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center mr-3 shadow-lg flex-shrink-0"><Bot className="w-5 h-5 text-white" /></div>
                            <span className={isCollapsed ? 'hidden' : 'block'}>ATLAS</span>
                        </h1>
                        <button onClick={() => setIsSidebarOpen(false)} className={`md:hidden ${isDarkMode ? 'text-slate-400 hover:text-white' : 'text-[#8a847a] hover:text-[#2d2a26]'}`}><X className="w-5 h-5" /></button>
                    </div>

                    <nav className="flex-1 p-4 space-y-2 mt-2">
                        {!isCollapsed && <div className="px-4 py-2 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Core Modules</div>}

                        <button onClick={() => { setCurrentView('doubt-solver'); setIsSidebarOpen(false); }} className={`w-full text-left py-3.5 rounded-xl flex items-center transition-all group ${isCollapsed ? 'px-3 justify-center' : 'px-4'} ${currentView === 'doubt-solver' ? 'bg-indigo-600/10 text-indigo-400 border border-indigo-500/20' : 'hover:bg-gray-800/50 hover:text-white border border-transparent'}`}>
                            <Bot className={`w-5 h-5 flex-shrink-0 ${isCollapsed ? '' : 'mr-3'} ${currentView === 'doubt-solver' ? 'text-indigo-400' : 'text-slate-500 group-hover:text-slate-300'}`} />
                            {!isCollapsed && <span className="font-semibold flex-grow">Doubt Solver</span>}
                            {currentView === 'doubt-solver' && <div className={`flex-shrink-0 ${isCollapsed ? '' : 'ml-auto'} w-1.5 h-1.5 rounded-full bg-indigo-400`} />}
                        </button>

                        <button onClick={() => { setCurrentView('college-compass'); setIsSidebarOpen(false); }} className={`w-full text-left py-3.5 rounded-xl flex items-center transition-all group ${isCollapsed ? 'px-3 justify-center' : 'px-4'} ${currentView === 'college-compass' ? 'bg-blue-600/10 text-blue-400 border border-blue-500/20' : 'hover:bg-gray-800/50 hover:text-white border border-transparent'}`}>
                            <GraduationCap className={`w-5 h-5 flex-shrink-0 ${isCollapsed ? '' : 'mr-3'} ${currentView === 'college-compass' ? 'text-blue-400' : 'text-slate-500 group-hover:text-slate-300'}`} />
                            {!isCollapsed && <span className="font-semibold flex-grow">College Finder</span>}
                            {currentView === 'college-compass' && <div className={`flex-shrink-0 ${isCollapsed ? '' : 'ml-auto'} w-1.5 h-1.5 rounded-full bg-blue-400`} />}
                        </button>

                        <button onClick={() => { setCurrentView('quiz-assessment'); setIsSidebarOpen(false); }} className={`w-full text-left py-3.5 rounded-xl flex items-center transition-all group ${isCollapsed ? 'px-3 justify-center' : 'px-4'} ${currentView === 'quiz-assessment' ? 'bg-purple-600/10 text-purple-400 border border-purple-500/20' : 'hover:bg-gray-800/50 hover:text-white border border-transparent'}`}>
                            <ClipboardList className={`w-5 h-5 flex-shrink-0 ${isCollapsed ? '' : 'mr-3'} ${currentView === 'quiz-assessment' ? 'text-purple-400' : 'text-slate-500 group-hover:text-slate-300'}`} />
                            {!isCollapsed && <span className="font-semibold flex-grow">Quiz & Assessment</span>}
                            {currentView === 'quiz-assessment' && <div className={`flex-shrink-0 ${isCollapsed ? '' : 'ml-auto'} w-1.5 h-1.5 rounded-full bg-purple-400`} />}
                        </button>

                        <button onClick={() => { setCurrentView('document-study'); setIsSidebarOpen(false); }} className={`w-full text-left py-3.5 rounded-xl flex items-center transition-all group ${isCollapsed ? 'px-3 justify-center' : 'px-4'} ${currentView === 'document-study' ? 'bg-amber-600/10 text-amber-400 border border-amber-500/20' : 'hover:bg-gray-800/50 hover:text-white border border-transparent'}`}>
                            <Upload className={`w-5 h-5 flex-shrink-0 ${isCollapsed ? '' : 'mr-3'} ${currentView === 'document-study' ? 'text-amber-400' : 'text-slate-500 group-hover:text-slate-300'}`} />
                            {!isCollapsed && <span className="font-semibold flex-grow">Document Study</span>}
                            {currentView === 'document-study' && <div className={`flex-shrink-0 ${isCollapsed ? '' : 'ml-auto'} w-1.5 h-1.5 rounded-full bg-amber-400`} />}
                        </button>
                    </nav>

                    <div className={`p-4 border-t ${isDarkMode ? 'border-gray-800/50' : 'border-[#e5dfd3]'} ${isCollapsed ? 'px-3' : 'px-5'} space-y-2`}>
                        {/* Theme Toggle */}
                        <button onClick={() => setIsDarkMode(!isDarkMode)} className={`w-full flex items-center ${isCollapsed ? 'justify-center' : 'justify-between'} p-2 rounded-xl ${isDarkMode ? 'text-slate-400 hover:bg-gray-800/50 hover:text-white' : 'text-[#8a847a] hover:bg-[#ebe5d9] hover:text-[#2d2a26]'} transition-all`}>
                            {!isCollapsed && <span className="text-sm font-medium">{isDarkMode ? 'Light Mode' : 'Dark Mode'}</span>}
                            {isDarkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
                        </button>
                        <button onClick={() => setIsCollapsed(!isCollapsed)} className={`w-full flex items-center ${isCollapsed ? 'justify-center' : 'justify-between'} p-2 rounded-xl ${isDarkMode ? 'text-slate-400 hover:bg-gray-800/50 hover:text-white' : 'text-[#8a847a] hover:bg-[#ebe5d9] hover:text-[#2d2a26]'}`}>
                            {!isCollapsed && <span className="text-sm font-medium">Collapse Menu</span>}
                            {isCollapsed ? <ChevronRight className="w-5 h-5" /> : <ChevronLeft className="w-5 h-5" />}
                        </button>
                    </div>
                </div>
            );

            return (
                <div className={`flex h-screen font-sans overflow-hidden ${isDarkMode ? 'bg-gray-900' : 'light-mode bg-[#faf8f5]'}`}>
                    <div className={`fixed inset-0 z-0 ${isDarkMode ? 'opacity-30' : 'opacity-20'} pointer-events-none`}>
                        <div className={`absolute top-0 left-0 w-96 h-96 ${isDarkMode ? 'bg-purple-600' : 'bg-amber-400'} rounded-full blur-[128px] -translate-x-1/2 -translate-y-1/2`}></div>
                        <div className={`absolute bottom-0 right-0 w-96 h-96 ${isDarkMode ? 'bg-blue-600' : 'bg-rose-300'} rounded-full blur-[128px] translate-x-1/2 -translate-y-1/2`}></div>
                    </div>

                    {isLoading && <SplashScreen onComplete={() => setIsLoading(false)} />}
                    <Sidebar />

                    <div className={`flex-1 flex flex-col h-full relative glass-panel rounded-l-[40px] shadow-2xl overflow-hidden my-0 md:my-2 md:mr-2 ${isDarkMode ? 'border-white/10' : 'border-[#e5dfd3]'} border transition-all duration-300`}>
                        <header className={`md:hidden glass-panel p-4 shadow-xl flex items-center z-30 sticky top-0 ${isDarkMode ? 'border-white/10' : 'border-[#e5dfd3]'} border-b`}>
                            <button onClick={() => setIsSidebarOpen(true)} className={`mr-3 ${isDarkMode ? 'text-slate-400 hover:text-white' : 'text-[#8a847a] hover:text-[#2d2a26]'}`}><Menu className="w-5 h-5" /></button>
                            <h1 className={`font-bold ${isDarkMode ? 'text-white' : 'text-[#2d2a26]'} flex items-center`}>
                                {currentView === 'doubt-solver' ? <Bot className="w-5 h-5 mr-2 text-indigo-400" /> : currentView === 'college-compass' ? <GraduationCap className="w-5 h-5 mr-2 text-blue-400" /> : currentView === 'document-study' ? <Upload className="w-5 h-5 mr-2 text-amber-400" /> : <FileText className="w-5 h-5 mr-2 text-purple-400" />}
                                {currentView === 'doubt-solver' ? 'Doubt Solver' : currentView === 'college-compass' ? 'College Finder' : currentView === 'document-study' ? 'Document Study' : 'Assessment'}
                            </h1>
                        </header>

                        <main className="flex-1 overflow-hidden relative">
                            <div key={currentView} className="h-full animate-view-transition">
                                {currentView === 'doubt-solver' ? <DoubtSolver retryableFetch={retryableFetch} isDarkMode={isDarkMode} /> : currentView === 'college-compass' ? <CollegeCompass retryableFetch={retryableFetch} isDarkMode={isDarkMode} /> : currentView === 'document-study' ? <DocumentStudy retryableFetch={retryableFetch} isDarkMode={isDarkMode} /> : <QuizAssessment retryableFetch={retryableFetch} isDarkMode={isDarkMode} />}
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>